"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

var _ShortCode = _interopRequireDefault(require("./ShortCode"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var querystring = require("querystring");

class Message {
  static get ERROR_MESSAGES() {
    return {
      sender: "Invalid from address",
      to: "Invalid to address",
      msg: "Invalid Text Message",
      body: "Invalid Body value in Binary Message",
      udh: "Invalid udh value in Binary Message",
      title: "Invalid title in WAP Push message",
      url: "Invalid url in WAP Push message"
    };
  }

  static get PATH() {
    return "/sms/json";
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition SMS options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;

    var _shortcode = new _ShortCode.default(this.creds, this.options);

    this.shortcodeAlert = _shortcode.shortcodeAlert.bind(_shortcode);
    this.shortcode2FA = _shortcode.shortcode2FA.bind(_shortcode);
    this.shortcodeMarketing = _shortcode.shortcodeMarketing.bind(_shortcode);
  }

  _checkToAndFrom(data) {
    if (!data.from) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.sender));
    } else if (!data.to) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.to));
    } else {
      return;
    }
  } // _sendMessageCallback


  _sendMessage(data, callback) {
    this._checkToAndFrom(data);

    this.options.logger.info("sending message from " + data.from + " to " + data.to + " with message " + data.text);
    var creds = {
      api_key: this.creds.apiKey,
      api_secret: this.creds.apiSecret
    };
    var body = Object.assign({}, creds, data);
    console.log({
      host: this.options.restHost || "rest.nexmo.com",
      path: Message.PATH,
      body: JSON.stringify(body),
      headers: {
        "Content-Type": "application/json"
      }
    });
    this.options.httpClient.request({
      host: this.options.restHost || "rest.nexmo.com",
      path: Message.PATH,
      body: JSON.stringify(body),
      headers: {
        "Content-Type": "application/json"
      }
    }, "POST", (err, apiResponse) => {
      if (!err && apiResponse.status && apiResponse.messages[0].status > 0) {
        _Utils.default.sendError(callback, new Error(apiResponse.messages[0]["error-text"]), apiResponse);
      } else {
        if (callback) callback(err, apiResponse);
      }
    });
  }
  /**
   * TODO: document
   */


  sendSms(sender, recipient, message, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.msg));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["text"] = message;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendBinaryMessage(sender, recipient, body, udh, opts, callback) {
    if (!body) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.body));
    } else if (!udh) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.udh));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "binary";
      opts["body"] = body;
      opts["udh"] = udh;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendWapPushMessage(sender, recipient, title, url, validity, opts, callback) {
    if (!title) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.title));
    } else if (!url) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.url));
    } else {
      if (typeof validity === "function") {
        callback = validity;
        opts = {};
        validity = 86400000;
      }

      if (typeof opts === "function") {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "wappush";
      opts["title"] = title;
      opts["validity"] = validity;
      opts["url"] = url;

      this._sendMessage(opts, callback);
    }
  }

  search(id, callback) {
    if (typeof id == "string") {
      return this.options.rest.get("/search/message", {
        id: id
      }, callback);
    } // Otherwise we expect an array


    return this.options.rest.get("/search/messages", {
      ids: id
    }, callback);
  }

  searchRejections(to, date, callback) {
    return this.options.rest.get("/search/rejections", {
      to,
      date
    }, callback);
  }

}

var _default = Message;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NZXNzYWdlLmpzIl0sIm5hbWVzIjpbInF1ZXJ5c3RyaW5nIiwicmVxdWlyZSIsIk1lc3NhZ2UiLCJFUlJPUl9NRVNTQUdFUyIsInNlbmRlciIsInRvIiwibXNnIiwiYm9keSIsInVkaCIsInRpdGxlIiwidXJsIiwiUEFUSCIsImNvbnN0cnVjdG9yIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJfc2hvcnRjb2RlIiwiU2hvcnRDb2RlIiwic2hvcnRjb2RlQWxlcnQiLCJiaW5kIiwic2hvcnRjb2RlMkZBIiwic2hvcnRjb2RlTWFya2V0aW5nIiwiX2NoZWNrVG9BbmRGcm9tIiwiZGF0YSIsImZyb20iLCJVdGlscyIsInNlbmRFcnJvciIsImNhbGxiYWNrIiwiRXJyb3IiLCJfc2VuZE1lc3NhZ2UiLCJsb2dnZXIiLCJpbmZvIiwidGV4dCIsImFwaV9rZXkiLCJhcGlLZXkiLCJhcGlfc2VjcmV0IiwiYXBpU2VjcmV0IiwiT2JqZWN0IiwiYXNzaWduIiwiY29uc29sZSIsImxvZyIsImhvc3QiLCJyZXN0SG9zdCIsInBhdGgiLCJKU09OIiwic3RyaW5naWZ5IiwiaGVhZGVycyIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwiZXJyIiwiYXBpUmVzcG9uc2UiLCJzdGF0dXMiLCJtZXNzYWdlcyIsInNlbmRTbXMiLCJyZWNpcGllbnQiLCJtZXNzYWdlIiwib3B0cyIsInNlbmRCaW5hcnlNZXNzYWdlIiwic2VuZFdhcFB1c2hNZXNzYWdlIiwidmFsaWRpdHkiLCJzZWFyY2giLCJpZCIsInJlc3QiLCJnZXQiLCJpZHMiLCJzZWFyY2hSZWplY3Rpb25zIiwiZGF0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFFQTs7OztBQUVBLElBQUlBLFdBQVcsR0FBR0MsT0FBTyxDQUFDLGFBQUQsQ0FBekI7O0FBRUEsTUFBTUMsT0FBTixDQUFjO0FBQ2EsYUFBZEMsY0FBYyxHQUFHO0FBQzFCLFdBQU87QUFDTEMsTUFBQUEsTUFBTSxFQUFF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QUNGOztBQUVEaUMsRUFBQUEsTUFBTSxDQUFDQyxFQUFELEVBQUtsQyxRQUFMLEVBQWU7QUFDbkIsUUFBSSxPQUFPa0MsRUFBUCxJQUFhLFFBQWpCLEVBQTJCO0FBQ3pCLGFBQU8sS0FBSy9DLE9BQUwsQ0FBYWdELElBQWIsQ0FBa0JDLEdBQWxCLENBQ0wsaUJBREssRUFFTDtBQUNFRixRQUFBQSxFQUFFLEVBQUVBO0FBRE4sT0FGSyxFQUtMbEMsUUFMSyxDQUFQO0FBT0QsS0FUa0IsQ0FXbkI7OztBQUNBLFdBQU8sS0FBS2IsT0FBTCxDQUFhZ0QsSUFBYixDQUFrQkMsR0FBbEIsQ0FDTCxrQkFESyxFQUVMO0FBQ0VDLE1BQUFBLEdBQUcsRUFBRUg7QUFEUCxLQUZLLEVBS0xsQyxRQUxLLENBQVA7QUFPRDs7QUFFRHNDLEVBQUFBLGdCQUFnQixDQUFDNUQsRUFBRCxFQUFLNkQsSUFBTCxFQUFXdkMsUUFBWCxFQUFxQjtBQUNuQyxXQUFPLEtBQUtiLE9BQUwsQ0FBYWdELElBQWIsQ0FBa0JDLEdBQWxCLENBQ0wsb0JBREssRUFFTDtBQUNFMUQsTUFBQUEsRUFERjtBQUVFNkQsTUFBQUE7QUFGRixLQUZLLEVBTUx2QyxRQU5LLENBQVA7QUFRRDs7QUE5TFc7O2VBaU1DekIsTyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vVXRpbHNcIjtcblxuaW1wb3J0IFNob3J0Q29kZSBmcm9tIFwiLi9TaG9ydENvZGVcIjtcblxudmFyIHF1ZXJ5c3RyaW5nID0gcmVxdWlyZShcInF1ZXJ5c3RyaW5nXCIpO1xuXG5jbGFzcyBNZXNzYWdlIHtcbiAgc3RhdGljIGdldCBFUlJPUl9NRVNTQUdFUygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc2VuZGVyOiBcIkludmFsaWQgZnJvbSBhZGRyZXNzXCIsXG4gICAgICB0bzogXCJJbnZhbGlkIHRvIGFkZHJlc3NcIixcbiAgICAgIG1zZzogXCJJbnZhbGlkIFRleHQgTWVzc2FnZVwiLFxuICAgICAgYm9keTogXCJJbnZhbGlkIEJvZHkgdmFsdWUgaW4gQmluYXJ5IE1lc3NhZ2VcIixcbiAgICAgIHVkaDogXCJJbnZhbGlkIHVkaCB2YWx1ZSBpbiBCaW5hcnkgTWVzc2FnZVwiLFxuICAgICAgdGl0bGU6IFwiSW52YWxpZCB0aXRsZSBpbiBXQVAgUHVzaCBtZXNzYWdlXCIsXG4gICAgICB1cmw6IFwiSW52YWxpZCB1cmwgaW4gV0FQIFB1c2ggbWVzc2FnZVwiLFxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgZ2V0IFBBVEgoKSB7XG4gICAgcmV0dXJuIFwiL3Ntcy9qc29uXCI7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtDcmVkZW50aWFsc30gY3JlZGVudGlhbHNcbiAgICogICAgY3JlZGVudGlhbHMgdG8gYmUgdXNlZCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIEFQSS5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAgICogICAgQWRkaXRpb24gU01TIG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICB2YXIgX3Nob3J0Y29kZSA9IG5ldyBTaG9ydENvZGUodGhpcy5jcmVkcywgdGhpcy5vcHRpb25zKTtcblxuICAgIHRoaXMuc2hvcnRjb2RlQWxlcnQgPSBfc2hvcnRjb2RlLnNob3J0Y29kZUFsZXJ0LmJpbmQoX3Nob3J0Y29kZSk7XG4gICAgdGhpcy5zaG9ydGNvZGUyRkEgPSBfc2hvcnRjb2RlLnNob3J0Y29kZTJGQS5iaW5kKF9zaG9ydGNvZGUpO1xuICAgIHRoaXMuc2hvcnRjb2RlTWFya2V0aW5nID0gX3Nob3J0Y29kZS5zaG9ydGNvZGVNYXJrZXRpbmcuYmluZChfc2hvcnRjb2RlKTtcbiAgfVxuXG4gIF9jaGVja1RvQW5kRnJvbShkYXRhKSB7XG4gICAgaWYgKCFkYXRhLmZyb20pIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMuc2VuZGVyKSk7XG4gICAgfSBlbHNlIGlmICghZGF0YS50bykge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy50bykpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG5cbiAgLy8gX3NlbmRNZXNzYWdlQ2FsbGJhY2tcblxuICBfc2VuZE1lc3NhZ2UoZGF0YSwgY2FsbGJhY2spIHtcbiAgICB0aGlzLl9jaGVja1RvQW5kRnJvbShkYXRhKTtcblxuICAgIHRoaXMub3B0aW9ucy5sb2dnZXIuaW5mbyhcbiAgICAgIFwic2VuZGluZyBtZXNzYWdlIGZyb20gXCIgK1xuICAgICAgICBkYXRhLmZyb20gK1xuICAgICAgICBcIiB0byBcIiArXG4gICAgICAgIGRhdGEudG8gK1xuICAgICAgICBcIiB3aXRoIG1lc3NhZ2UgXCIgK1xuICAgICAgICBkYXRhLnRleHRcbiAgICApO1xuXG4gICAgbGV0IGNyZWRzID0ge1xuICAgICAgYXBpX2tleTogdGhpcy5jcmVkcy5hcGlLZXksXG4gICAgICBhcGlfc2VjcmV0OiB0aGlzLmNyZWRzLmFwaVNlY3JldCxcbiAgICB9O1xuXG4gICAgbGV0IGJvZHkgPSBPYmplY3QuYXNzaWduKHt9LCBjcmVkcywgZGF0YSk7XG4gICAgY29uc29sZS5sb2coe1xuICAgICAgaG9zdDogdGhpcy5vcHRpb25zLnJlc3RIb3N0IHx8IFwicmVzdC5uZXhtby5jb21cIixcbiAgICAgIHBhdGg6IE1lc3NhZ2UuUEFUSCxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGJvZHkpLFxuICAgICAgaGVhZGVyczogeyBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxuICAgIH0pO1xuICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICB7XG4gICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5yZXN0SG9zdCB8fCBcInJlc3QubmV4bW8uY29tXCIsXG4gICAgICAgIHBhdGg6IE1lc3NhZ2UuUEFUSCxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoYm9keSksXG4gICAgICAgIGhlYWRlcnM6IHsgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIgfSxcbiAgICAgIH0sXG4gICAgICBcIlBPU1RcIixcbiAgICAgIChlcnIsIGFwaVJlc3BvbnNlKSA9PiB7XG4gICAgICAgIGlmICghZXJyICYmIGFwaVJlc3BvbnNlLnN0YXR1cyAmJiBhcGlSZXNwb25zZS5tZXNzYWdlc1swXS5zdGF0dXMgPiAwKSB7XG4gICAgICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgICAgICBuZXcgRXJyb3IoYXBpUmVzcG9uc2UubWVzc2FnZXNbMF1bXCJlcnJvci10ZXh0XCJdKSxcbiAgICAgICAgICAgIGFwaVJlc3BvbnNlXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGVyciwgYXBpUmVzcG9uc2UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VuZFNtcyhzZW5kZXIsIHJlY2lwaWVudCwgbWVzc2FnZSwgb3B0cywgY2FsbGJhY2spIHtcbiAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMubXNnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2sgPSBvcHRzO1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1wiZnJvbVwiXSA9IHNlbmRlcjtcbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0ZXh0XCJdID0gbWVzc2FnZTtcbiAgICAgIHRoaXMuX3NlbmRNZXNzYWdlKG9wdHMsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHNlbmRCaW5hcnlNZXNzYWdlKHNlbmRlciwgcmVjaXBpZW50LCBib2R5LCB1ZGgsIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFib2R5KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLmJvZHkpKTtcbiAgICB9IGVsc2UgaWYgKCF1ZGgpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudWRoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2sgPSBvcHRzO1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1wiZnJvbVwiXSA9IHNlbmRlcjtcbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0eXBlXCJdID0gXCJiaW5hcnlcIjtcbiAgICAgIG9wdHNbXCJib2R5XCJdID0gYm9keTtcbiAgICAgIG9wdHNbXCJ1ZGhcIl0gPSB1ZGg7XG4gICAgICB0aGlzLl9zZW5kTWVzc2FnZShvcHRzLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBzZW5kV2FwUHVzaE1lc3NhZ2Uoc2VuZGVyLCByZWNpcGllbnQsIHRpdGxlLCB1cmwsIHZhbGlkaXR5LCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghdGl0bGUpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudGl0bGUpKTtcbiAgICB9IGVsc2UgaWYgKCF1cmwpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudXJsKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0eXBlb2YgdmFsaWRpdHkgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjYWxsYmFjayA9IHZhbGlkaXR5O1xuICAgICAgICBvcHRzID0ge307XG4gICAgICAgIHZhbGlkaXR5ID0gODY0MDAwMDA7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIG9wdHMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjYWxsYmFjayA9IG9wdHM7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJmcm9tXCJdID0gc2VuZGVyO1xuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInR5cGVcIl0gPSBcIndhcHB1c2hcIjtcbiAgICAgIG9wdHNbXCJ0aXRsZVwiXSA9IHRpdGxlO1xuICAgICAgb3B0c1tcInZhbGlkaXR5XCJdID0gdmFsaWRpdHk7XG4gICAgICBvcHRzW1widXJsXCJdID0gdXJsO1xuICAgICAgdGhpcy5fc2VuZE1lc3NhZ2Uob3B0cywgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIHNlYXJjaChpZCwgY2FsbGJhY2spIHtcbiAgICBpZiAodHlwZW9mIGlkID09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmVzdC5nZXQoXG4gICAgICAgIFwiL3NlYXJjaC9tZXNzYWdlXCIsXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogaWQsXG4gICAgICAgIH0sXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSB3ZSBleHBlY3QgYW4gYXJyYXlcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLnJlc3QuZ2V0KFxuICAgICAgXCIvc2VhcmNoL21lc3NhZ2VzXCIsXG4gICAgICB7XG4gICAgICAgIGlkczogaWQsXG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgc2VhcmNoUmVqZWN0aW9ucyh0bywgZGF0ZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLnJlc3QuZ2V0KFxuICAgICAgXCIvc2VhcmNoL3JlamVjdGlvbnNcIixcbiAgICAgIHtcbiAgICAgICAgdG8sXG4gICAgICAgIGRhdGUsXG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IE1lc3NhZ2U7XG4iXX0=